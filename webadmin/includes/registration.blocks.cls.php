<?php
   include_once("_framework/_nemo.list.cls.php");


## TRANSLATIONS
$_TRANSLATION["EN"]["Content"] = "  In order to complete your registration as quickly as possible you will require the following:
                                    <ul>
                                       <li>Business Registration & Legal Docs</li>
                                       <li>Owner information</li>
                                       <li>etc</li>
                                    </ul>";

$_TRANSLATION["AF"]["Content"] = "  Om die registrasie so gou as moontlik te doen het u die volgende nodig:
                                    <ul>
                                       <li>Besigheid regestrasie en Dokumente</li>
                                       <li>Eienaar Informasie</li>
                                       <li>En so voorts</li>
                                    </ul>";

$_TRANSLATION["EN"]["Question"] = "Do you have a SAWIS Member Number?";
$_TRANSLATION["AF"]["Question"] = "Het u 'n SAWIS lidnommer?";
$_TRANSLATION["EN"]["NumberBlocks"] = "Indicate the Number of blocks the farm has";
$_TRANSLATION["AF"]["NumberBlocks"] = "AF:Indicate the Number of blocks the farm has";
$_TRANSLATION["EN"]["TitleBlocks"] = "Farm Blocks";
$_TRANSLATION["AF"]["TitleBlocks"] = "Plaas Blokke";
$_TRANSLATION["EN"]["btnAddBlock"] = "Add Block";
$_TRANSLATION["AF"]["btnAddBlock"] = "Voeg Blok";
$_TRANSLATION["EN"]["intYear"] = "Year";
$_TRANSLATION["AF"]["intYear"] = "Jaar";
$_TRANSLATION["EN"]["strBlock"] = "Block Name/Number";
$_TRANSLATION["AF"]["strBlock"] = "Block Naam/Nommer"; 
$_TRANSLATION["EN"]["refCultivarID"] = "Variety";
$_TRANSLATION["AF"]["refCultivarID"] = "Verskeidenheid";
$_TRANSLATION["EN"]["refCultivarRootstockID"] = "Rootstock graft";
$_TRANSLATION["AF"]["refCultivarRootstockID"] = "Onderstok oorplant";
$_TRANSLATION["EN"]["refIrrigationID"] = "Irrigation";
$_TRANSLATION["AF"]["refIrrigationID"] = "Besproeiing";
$_TRANSLATION["EN"]["refTrellisID"] = "Trellis";
$_TRANSLATION["AF"]["refTrellisID"] = "Prieel";
$_TRANSLATION["EN"]["dblHectare"] = "Hectare";
$_TRANSLATION["AF"]["dblHectare"] = "Hektaar";
$_TRANSLATION["EN"]["dblRowSpacingWide"] = "Row Spacing Wide (m)";
$_TRANSLATION["AF"]["dblRowSpacingWide"] = "AF: Row Spacing Wide (m)";
$_TRANSLATION["EN"]["dblRowSpacingNarrow"] = "Row Spacing Narrow (m)";
$_TRANSLATION["AF"]["dblRowSpacingNarrow"] = "AF: Row Spacing Narrow (m)";
$_TRANSLATION["EN"]["dblVineSpacing"] = "Vine Spacing (m)";
$_TRANSLATION["AF"]["dblVineSpacing"] = "AF: Vine Spacing (m)";
$_TRANSLATION["EN"]["dblVineDencity"] = "Vine Density";
$_TRANSLATION["AF"]["dblVineDencity"] = "AF: Vine Density"; 
$_TRANSLATION["EN"]["intVinesOpening"] = "Number of Vines";
$_TRANSLATION["AF"]["intVinesOpening"] = "AF: Number of Vines"; 
$_TRANSLATION["EN"]["strGPS"] = "GPS";
$_TRANSLATION["AF"]["strGPS"] = "GPS"; 
$_TRANSLATION["EN"]["strGISProject"] = "Learn more about our GIS project";
$_TRANSLATION["AF"]["strGISProject"] = "AF: Learn more about our GIS project"; 
$_TRANSLATION["EN"]["strDescription"] = "Description";
$_TRANSLATION["AF"]["strDescription"] = "Beskrywing"; 
$_TRANSLATION["EN"]["FarmBHeading"] = "Farm Blocks";
$_TRANSLATION["AF"]["FarmBHeading"] = "Plaas Blokke";
$_TRANSLATION["EN"]["GroupingHeading1"] = "General";
$_TRANSLATION["AF"]["GroupingHeading1"] = "Algemene";
$_TRANSLATION["EN"]["GroupingHeading2"] = "Specifications";
$_TRANSLATION["AF"]["GroupingHeading2"] = "Spesifikasies";

##SUBDIVISION
$_TRANSLATION["EN"]["subDivHeading"] = "Farm Blocks Subdivision";
$_TRANSLATION["AF"]["subDivHeading"] = "Plaas Blokke Onderverdeling";
$_TRANSLATION["EN"]["subDivInstructions"] = "Please select the farm blocks you would like to transfer: ";
$_TRANSLATION["AF"]["subDivInstructions"] = "AF: Please select the farm blocks you would like to transfer: ";
$_TRANSLATION["EN"]["reviewSubDiv1"] = "Blocks you want to transfer: ";
$_TRANSLATION["AF"]["reviewSubDiv1"] = "AF: Blocks you want to transfer: ";
$_TRANSLATION["EN"]["reviewSubDiv2"] = "Blocks you do not want to transfer: ";
$_TRANSLATION["AF"]["reviewSubDiv2"] = "AF: Blocks you do not want to transfer: ";

                           
##BUTTONS
$_TRANSLATION["EN"]["optSelect"] = "- Select -";
$_TRANSLATION["AF"]["optSelect"] = "- Kies -";
$_TRANSLATION["EN"]["btnCheck"] = "Check";
$_TRANSLATION["AF"]["btnCheck"] = "Kontroleer";
$_TRANSLATION["EN"]["btnNext"] = "Next";
$_TRANSLATION["AF"]["btnNext"] = "Volgende";
$_TRANSLATION["EN"]["btnPrevious"] = "Previous";
$_TRANSLATION["AF"]["btnPrevious"] = "Vorige";
$_TRANSLATION["EN"]["btnContinue"] = "Continue";
$_TRANSLATION["AF"]["btnContinue"] = "Gaan voort";
$_TRANSLATION["EN"]["btnLoadDraft"]= "Load Draft";
$_TRANSLATION["AF"]["btnLoadDraft"]= "Laai";
$_TRANSLATION["EN"]["btnSubmit"] = "Submit Application";
$_TRANSLATION["AF"]["btnSubmit"] = "Dien in";
$_TRANSLATION["EN"]["linkView"] = "View";
$_TRANSLATION["AF"]["linkView"] = "AF: View";
$_TRANSLATION["EN"]["linkViewMap"] = "View Google Map";
$_TRANSLATION["AF"]["linkViewMap"] = "AF: View Google Map";
$_TRANSLATION["EN"]["notGrafted"] = "n/a";
$_TRANSLATION["AF"]["notGrafted"] = "AF: n/a";



$_TRANSLATION["EN"]["validationMessage"] = "Please check if all fields are filled in.";
$_TRANSLATION["AF"]["validationMessage"] = "AF: Please check if all fields are filled in.";
$_TRANSLATION["EN"]["deleteBlockMessage"] = "Are you sure you want to delete this block?";
$_TRANSLATION["AF"]["deleteBlockMessage"] = "AF: Are you sure you want to delete this block?";
$_TRANSLATION["EN"]["newBlock"] = "New";
$_TRANSLATION["AF"]["newBlock"] = "Nuwe";

## VALIDATION
$_TRANSLATION["EN"]["valid_NumBlocks"] = "Please enter a valid number of blocks to add, 1 was added by default.";
$_TRANSLATION["AF"]["valid_NumBlocks"] = "AF: Please enter a valid number of blocks to add, 1 was added by default.";
$_TRANSLATION["EN"]["valid_Year"] = "Please enter a valid year, between 1920 and the current year only.";
$_TRANSLATION["AF"]["valid_Year"] = "AF: Please enter a valid year, between 1920 and the current year only.";
$_TRANSLATION["EN"]["valid_BlockName"] = "Please enter a Block Name/Number before moving forward.";
$_TRANSLATION["AF"]["valid_BlockName"] = "AF: Please enter a Block Name/Number before moving forward.";
$_TRANSLATION["EN"]["valid_Variety"] = "Please select a Variety before moving forward.";
$_TRANSLATION["AF"]["valid_Variety"] = "AF: Please select a Variety before moving forward.";
$_TRANSLATION["EN"]["valid_Rootstock"] = "Please select a Rootstock before moving forward.";
$_TRANSLATION["AF"]["valid_Rootstock"] = "AF: Please select a Rootstock before moving forward.";
$_TRANSLATION["EN"]["valid_Irrigation"] = "Please select Irrigation type before moving forward.";
$_TRANSLATION["AF"]["valid_Irrigation"] = "AF: Please select Irrigation type before moving forward.";
$_TRANSLATION["EN"]["valid_Hectare"] = "Please enter a valid value for Hectare.$BR";
$_TRANSLATION["AF"]["valid_Hectare"] = "AF: Please enter a valid value for Hectare.$BR";
$_TRANSLATION["EN"]["valid_RowSpacingWide"] = "Please enter a valid value for Row Spacing Wide.$BR";
$_TRANSLATION["AF"]["valid_RowSpacingWide"] = "AF: Please enter a valid value for Row Spacing Wide.$BR";
$_TRANSLATION["EN"]["valid_RowSpacingNarrow"] = "????";
$_TRANSLATION["AF"]["valid_RowSpacingNarrow"] = "AF:";
$_TRANSLATION["EN"]["valid_VineSpacing"] = "Please enter a valid value for Vine Spacing.$BR";
$_TRANSLATION["AF"]["valid_VineSpacing"] = "AF: Please enter a valid value for Vine Spacing.$BR";
$_TRANSLATION["EN"]["valid_VinesOpening"] = "Please enter a valid value for Number of Vines.$BR";
$_TRANSLATION["AF"]["valid_VinesOpening"] = "AF: Please enter a valid value for Number of Vines.$BR";
$_TRANSLATION["EN"]["valid_Trellis"] = "Please select a Trellis before moving forward.$BR";
$_TRANSLATION["AF"]["valid_Trellis"] = "AF: Please select a Trellis before moving forward.$BR";
$_TRANSLATION["EN"]["valid_Description"] = "";
$_TRANSLATION["AF"]["valid_Description"] = "AF:";
$_TRANSLATION["EN"]["valid_Specifications"] = "Please enter a valid value for Row Spacing Wide.$BR Please enter a valid value for Vine Spacing.$BR Please enter a valid value for Number of Vines.";
$_TRANSLATION["AF"]["valid_Specifications"] = "AF: Please enter a valid value for Row Spacing Wide.$BR Please enter a valid value for Vine Spacing.$BR Please enter a valid value for Number of Vines.";
$_TRANSLATION["EN"]["valid_Specifications_Width"] = "Please make sure Row Spacing Wide is greater than or equal to Vine Spacing.";
$_TRANSLATION["AF"]["valid_Specifications_width"] = "AF: Please make sure Row Spacing Wide is greater than or equal to Vine Spacing.";


class RegistrationFarmBlocks extends NemoList
{
   private $ID = 0;

   public $FarmID = null;

   public function __construct($DataKey)
   {  
      parent::__construct($DataKey);
   }

   ## GET CONTENT FOR LANDING PAGE ########################################################################################################################################################
   ########################################################################################################################################################################################
   ########################################################################################################################################################################################
   
   public function getLandingPageContent()
   {  
      ## GLOBAL VARS
      global $xdb, $arrSys, $TR, $SP, $BR, $HR, $DATABASE_SETTINGS, $SystemSettings, $imgRequired,$_TRANSLATION; 

      ## HTML CONTENT
      $Content =  $_TRANSLATION[$_SESSION[USER]->LANGUAGE]["Content"] ."
      <div> 
         $BR
         <table width='100%'>
            <tr>
               <td><label for='OptionA1'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["NumberBlocks"].": </label>$imgRequired</td>
               <td align='right'><input type='number' id='intNumbBlocks' name='intNumbBlocks' style='text-align:right; padding-right:4px;' onblur='removeAlpha(this); jsNoOfBlocksValidation();' class='controlText' value='1' /></td>
               <td align='right' width='50px'></td>
            </tr>
         </table> 
         <div id='ErrorContent_intNumbBlocks' class='Error_Text'></div>
      </div>";

      ## JAVASCRIPT
      $JS = "  <script> 
                  function jsNoOfBlocksValidation()
                  {
                     $('.Error_Text').slideUp('fast');
                     msg = '';

                     if($('#intNumbBlocks').val() == 0)
                     {
                        $('#intNumbBlocks').attr('value','1');
                        $('#ErrorContent_intNumbBlocks').html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_NumBlocks"]."\")
                        $('#ErrorContent_intNumbBlocks').slideDown('fast');
                        msg += \"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_NumBlocks"]." \\n\"
                     }

                  }
               </script>";

      ## RETURN
      return $Content . $JS;
   }

   ## GET CONTENT FOR BLOCK SETUP PAGE ####################################################################################################################################################
   ########################################################################################################################################################################################
   ########################################################################################################################################################################################

   public static function getBlockSetupTypeContent($FarmID)
   {  

      global $xdb, $arrSys, $BR, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings,$_TRANSLATION; 

      $BlockContent = "";
      $Content = "";
      $registrationType = $_GET[status];

      ## GET YEAR FROM SYSYEAR TABLE
      $rowYear = $xdb->getRowSQL("SELECT intYear AS 'Year' FROM sysYear");

      if(isset($_SESSION[S1REGISTRATION]->NumberBlocks))
      {
         $NumBlocks = $_SESSION[S1REGISTRATION]->NumberBlocks;          

         for ($i=1; $i <= $NumBlocks; $i++) 
         { 
            $rowBlock->intYear = $rowYear->Year;
            $rowBlock->dblHectare = 0;  
            $rowBlock->dblRowSpacingWide = 0; 
            $rowBlock->dblRowSpacingNarrow = 0;  
            $rowBlock->dblVineSpacing = 0;  
            $rowBlock->intVinesOpening = 0; 

            $arrBlock[$i] = $rowBlock;
         }   
      }

      //else if(!isset($_SESSION[S1REGISTRATION]->NumberBlocks) || $_GET[status] == "buy"){
      $rstBlock = $xdb->doQuery("
         SELECT *,tmpBlock.strDescription 
         FROM tmpBlock 
         LEFT JOIN vieCultivar_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refCultivarID = vieCultivar_". $_SESSION[USER]->LANGUAGE .".CultivarID
         LEFT JOIN vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refCultivarRootstockID = vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE .".CultivarID
         LEFT JOIN vieIrrigation_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refIrrigationID = vieIrrigation_". $_SESSION[USER]->LANGUAGE .".IrrigationID
         LEFT JOIN vieTrellis_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refTrellisID = vieTrellis_". $_SESSION[USER]->LANGUAGE .".TrellisID
         WHERE refFarmID = '$FarmID' AND tmpBlock.strStatus = 'New'
         ORDER BY tmpBlock.strBlock",0);

      while($row = $xdb->fetch_object($rstBlock))
      {
         $arrBlock[] = $row;
      }

      //}

      ## GENEERATE THE AMOUNT OF SPECIFIED BLOCKS
      foreach($arrBlock as $x => $rowBlock) 
      {
         ## INI
         $txtGraftChecked = "";
         $txtRootstockDisabled = "disabled";

         //if the rootstock is not the same as the variety, then the rootstock has been set and blnGraft should be checked
         if($rowBlock->refCultivarRootstockID != $rowBlock->refCultivarID)
         {
            $txtGraftChecked = "checked";
            $txtRootstockDisabled = "";
         }

         ## GENERATING CULTIVAR DDL  
         $ddlCultivar = $xdb->ListOptions("SELECT CultivarID AS 'ControlValue', strCultivar AS 'ControlText' FROM vieCultivar_".$_SESSION[USER]->LANGUAGE." 
                                           WHERE blnCertifiable = 1 AND blnActive = 1 ORDER BY strCultivar ASC", $rowBlock->refCultivarID);

         ## GENERATING ROOTSTOCK DDL
         $ddlCultivarRootstock = $xdb->ListOptions("SELECT CultivarID AS 'ControlValue', strCultivar AS 'ControlText' FROM vieCultivarRootstock_".$_SESSION[USER]->LANGUAGE." 
                                                    WHERE blnActive = 1 ORDER BY strCultivar ASC", $rowBlock->refCultivarRootstockID);
         
         ## GENERATING IRRIGATION DDL 
         $ddlIrrigation = $xdb->ListOptions("SELECT IrrigationID AS 'ControlValue', strIrrigation AS 'ControlText' FROM vieIrrigation_".$_SESSION[USER]->LANGUAGE." 
                                             WHERE blnActive = 1 ORDER BY strIrrigation ASC", $rowBlock->refIrrigationID);
         
         ## GENERATING TRELLIS DDL 
         $ddlTrellis = "";
         $rstT = $xdb->doQuery("SELECT TrellisID AS 'ControlValue', strDescription AS 'ControlText', strFilename 
                                FROM vieTrellis_".$_SESSION[USER]->LANGUAGE." 
                                WHERE blnActive = 1 
                                ORDER BY strDescription ASC", 0);

         while($rowT = $xdb->fetch_object($rstT))
         {         
            $ddlTrellis .= "<option value='$rowT->ControlValue' filename='$rowT->strFilename' ". ($rowBlock->refTrellisID == $rowT->ControlValue ? "selected":"") .">
            $rowT->ControlText</option>";  
         }
  
         ## HEADING
         $Heading = "<i style='color:red; font-weight:normal;'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["newBlock"]."</i>$SP$SP$SP";
         if(isset($rowBlock->strBlock))
         {
            $Heading = $rowBlock->strBlock;
         }
            
         if(!isset($rowBlock->dblHectare))
         {
            $rowBlock->dblHectare = 0;
         }

         if($registrationType == "consolidate")
         {
            $btnDelete = "";
            $btnAddBlock = "";
         }
         else
         {
            if(!isset($rowBlock->ID))
            {
               $rowBlock->ID = 0;
            }
            $btnDelete = "<img class='Block_Img_Remove' id='remove$x' onClick='jsRemoveBlock(this,$x,$rowBlock->ID);' width='17px' src='images/delete.png' />";
            $btnAddBlock = "<input type='button' name='Action' id='btnAdd' class='controlButton'  value='".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["btnAddBlock"]."' onClick='jsAddBlock();'  /> ";
         }

         ## GO

         ## BLOCK HTML 
         $BlockContent .= "
         <input type='hidden' name='arrID[$x]' value='$rowBlock->ID' />
         <input type='hidden' id='arrDelete_$x' name='arrDelete[$x]' value='0'>
         <div>  
            <input id='status_$x' type='hidden' value='OFF' />
            <div onclick='jsAccordian(this);jsCheckImageShow($x)' class='BlockHeader' id='$x' name='arrBlock'>
              $btnDelete
               <img class='Block_Img' id='DD_Img$x' width='17px' src='images/arrow_blue.png' />
               <table style='margin-bottom:0px;'>
                  <tr>
                     <td><h3 class='h3x'>$x: </h3></td>
                     <td>
                        <h3 class='h3x'>
                        $Heading 
                        </h3>
                     </td>
                  </tr>
               </table>
            </div>
            <div style='background-color:#f3f3f3; display:none; padding-top:10px; padding-bottom:10px;' class='dd' id='DD_$x'>
               <div class='DivBlockColumn' style='padding:0px 15px 0px 0px; border-right:1px groove #333;'>
                  <div class='GroupingDiv'> 
                     <div class='GroupingHeading' >".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["GroupingHeading1"]."</div>
                     <table width='100%' style='margin-bottom:0px' cellpadding=0 cellspacing=0 border=0>
                        <col width='62%'>
                        <col width='38%'>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intYear"].": </label></td>
                           <td><input type='number' name='intYear[$x]' id='intYear_$x' onblur='removeAlpha(this);' onChange='jsIsValidYear($x)' class='controlText' style='width:95%;text-align:right'
                              value='$rowBlock->intYear' /></td> 
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strBlock"].": </label></td>
                           <td><input  type='text' name='strBlock[$x]' id='strBlock_$x'  onChange='jsIsValidBlockName($x);jsChangeName($x);' class='controlText' style='width:95%;'
                              value='$rowBlock->strBlock' /></td> 
                        </tr> 
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarID"].": </label></td>
                           <td><select name='refCultivarID[$x]' id='refCultivarID_$x' onChange='jsIsValidVariety($x)' style='width:103%;' class='controlText' >
                              <option value='0'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlCultivar</select></td>
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarRootstockID"].": </label><input id='blnGraft_$x' type='checkbox' name='blnGraft[$x]' onclick='jsToggleRootstock($x)' $txtGraftChecked></td>
                           <td><select  name='refCultivarRootstockID[$x]' id='refCultivarRootstockID_$x' onChange='jsIsValidRootstock($x)' style='width:103%;' class='controlText' $txtRootstockDisabled>
                              <option value='0'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlCultivarRootstock</select></td>
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refIrrigationID"].": </label></td>
                           <td><select name='refIrrigationID[$x]' id='refIrrigationID_$x' onChange='jsIsValidIrrigation($x)' style='width:103%;' class='controlText' >
                              <option value='0'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlIrrigation</select></td>
                        </tr>    
                     </table>
                  </div>
               </div>

               <div class='DivBlockColumn' style='padding:0px 0px 0px 15px; '>
                  <div class='GroupingDiv'> 
                     <div class='GroupingHeading' >".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["GroupingHeading2"]."</div>
                     <table width='100%' style='margin-bottom:0px' cellpadding=0 cellspacing=0 border=0>
                        <col width='62%'>
                        <col width='38%'>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingWide"].": </label></td>
                           <td><input type='text' name='dblRowSpacingWide[$x]' id='dblRowSpacingWide_$x' onblur='removeAlpha(this);jsCalculateHectare($x);jsIsValidWidth($x)'  class='controlText' style='width:95%;text-align:right' 
                              value='$rowBlock->dblRowSpacingWide'/></td> 
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingNarrow"].": </label></td>
                           <td><input  type='text' name='dblRowSpacingNarrow[$x]' id='dblRowSpacingNarrow_$x' onblur='removeAlpha(this);'class='controlText' style='width:95%;text-align:right' 
                              value='$rowBlock->dblRowSpacingNarrow'/></td> 
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblVineSpacing"].": </label></td>
                           <td><input type='text' name='dblVineSpacing[$x]' id='dblVineSpacing_$x'  onblur='removeAlpha(this);jsCalculateHectare($x);jsIsValidWidth($x)'  class='controlText' style='width:95%;text-align:right' 
                              value='$rowBlock->dblVineSpacing'/></td> 
                        </tr> 
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intVinesOpening"].": </label></td>
                           <td><input type='text' name='intVinesOpening[$x]' id='intVinesOpening_$x' onblur='removeAlpha(this);jsCalculateHectare($x);' class='controlText' style='width:95%;text-align:right' 
                              value='$rowBlock->intVinesOpening'/></td> 
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblHectare"].": </label></td>
                           <td><input type='text' name='dblHectare[$x]' id='dblHectare_$x' onblur='removeAlpha(this);jsCalculateHectare($x);'  class='controlLabel' style='width:99%;text-align:right;border-top:1px solid #000000 ;'
                              value='$rowBlock->dblHectare'/></td> 
                        </tr>
                     </table>
                  </div>      
               </div>                
               <div style='clear:both;'></div>
               <div style='width:100%;'>
                  <table width='100%' cellpadding=0 cellspacing=0 border=0>
                     <tr>
                        <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refTrellisID"].": </label>
                           <select name='refTrellisID[$x]' id='refTrellisID_$x' onChange='jsGetTrellisImage(this, $x);jsIsValidTrellis($x)' onload='jsCheckIfSelected($x)' style=' width:53%;margin-left:190px' class='controlText' >
                           <option value='0' filename=''>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlTrellis</select>
                           <a id='aTrellis_$x' href target='_blank' style ='margin-left:40px' hidden>-".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]."-</a>
                        </td>
                     </tr>
                     <tr>
                        <td>
                           <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGPS"].": </label>
                           <input type='text' name='strGPS[$x]' id='strGPS_$x' class='controlText' onChange='jsShowGoogleMap($x);' style='width:52%;margin-left:201px' maxlength='100' value='$rowBlock->strGPS'/>
                           <a id='mapLink_$x' href='http://maps.google.com' target='_blank' style='padding-left:13px' hidden>-".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkViewMap"]."-</a>
                        </td> 
                     </tr>
                     <tr><td><a href='".$SystemSettings[GISProjectURL]."' target='_blank' style='margin-left:231px'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGISProject"]."</a></td></tr>
                     <tr>
                        <td width='100%'>
                           <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strDescription"]."</label>
                           $BR<textarea name='txtDescription[$x]' id='txtDescription_$x' class='controlText' style='width:98%;'>$rowBlock->strDescription</textarea>
                        </td> 
                     </tr>
                  </table>
               </div>
               <div id='ErrorContent_intYear_$x' class='Error_Text'></div>
               <div id='ErrorContent_BlockName_$x' class='Error_Text'></div>
               <div id='ErrorContent_Variety_$x' class='Error_Text'></div>
               <div id='ErrorContent_Rootstock_$x' class='Error_Text'></div>
               <div id='ErrorContent_Irrigation_$x' class='Error_Text'></div>
               <div id='ErrorContent_Trellis_$x' class='Error_Text'></div>
               <div id='ErrorContent_Specifications_$x' class='Error_Text'></div>
               <div id='ErrorContent_Specifications_Width_$x' class='Error_Text'></div>
            </div>
            <div style='border-bottom:1px groove #333;'></div>$BR
         </div>"; 
      }//eoFOR
    
      /*<input type='hidden' id='arrDelete' name='arrDelete' value='0'> */
      $COPYCONTENT = "
         <div id='CopyBlock' style='display:none;'>  
            <input id='status' type='hidden' value='OFF' />
            <input type='hidden' id='arrID' name='' value='0'>
            <input type='hidden' id='arrDelete' name='' value='0'>
            <div onclick='jsAccordian(this);' class='BlockHeader' id='' name='arrBlock'>
               <img class='Block_Img_Remove' id='remove' onClick='jsRemoveBlock(this);' width='17px' src='images/delete.png' />
               <img class='Block_Img' id='DD_Img' width='17px' src='images/arrow_blue.png' />
               <table style='margin-bottom:0px;'>
                  <tr>
                     <td><h3 class='h3x CopyCounter'> </h3></td>
                     <td>
                        <h3 class='h3x'>
                           <i style='color:red; font-weight:normal;'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["newBlock"]."</i>$SP$SP$SP
                           <span class='h3x' id='BlockName'></span>
                        </h3>
                     </td>
                  </tr>
               </table>
            </div>
            <div style='background-color:#f3f3f3; display:none; padding-top:10px; padding-bottom:10px;' class='dd' id='DD'>
               <input type='hidden' id='Block_ID' name='' />
               <div class='DivBlockColumn' style='padding:0px 15px 0px 0px; border-right:1px groove #333;'>
                  <div class='GroupingDiv'> 
                     <div class='GroupingHeading' >".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["GroupingHeading1"]."</div>
                     <table width='100%' style='margin-bottom:0px' cellpadding=0 cellspacing=0 border=0>
                        <col width='62%'>
                        <col width='38%'>
                        <tr>
                           <td ><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intYear"].": </label></td>
                           <td><input type='number' name='' id='intYear' onblur='removeAlpha(this);' onChange class='controlText' style='width:95%;text-align:right' 
                              value='$rowYear->Year'/></td> 
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strBlock"].": <label></td>
                           <td><input type='text' name='' id='strBlock' onChange class='controlText' style='width:95%;'  /></td> 
                        </tr> 
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarID"].": </label></td>
                           <td><select name='' id='refCultivarID' onChange style='width:103%;' class='controlText' >
                              <option value='0'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlCultivar</select></td>
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarRootstockID"].": </label><input id='blnGraft' type='checkbox' name='' onclick></td>
                           <td><select  name='' id='refCultivarRootstockID' onChange style='width:103%;' class='controlText' >
                              <option value='0'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlCultivarRootstock</select></td>
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refIrrigationID"].": </label></td>
                           <td><select name='' id='refIrrigationID' onChange style='width:103%;' class='controlText' >
                              <option value='0'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlIrrigation</select></td>
                        </tr>
                     </table>
                  </div>
               </div>
               <div class='DivBlockColumn' style='padding:0px 0px 0px 15px; '>
                  <div class='GroupingDiv'> 
                     <div class='GroupingHeading' >".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["GroupingHeading2"]."</div>
                     <table width='100%' style='margin-bottom:0px' cellpadding=0 cellspacing=0 border=0>
                        <col width='62%'>
                        <col width='38%'>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingWide"].": </label></td>
                           <td><input  type='text' name='' id='dblRowSpacingWide' onChange onblur='removeAlpha(this);' class='controlText' style='width:95%;text-align:right' /></td> 
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingNarrow"].": </label></td>
                           <td><input  type='text'  name='' id='dblRowSpacingNarrow' onblur='removeAlpha(this);' class='controlText' style='width:95%;text-align:right'/></td> 
                        </tr>
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblVineSpacing"].": </label></td>
                           <td><input type='text' name='' id='dblVineSpacing' onChange  class='controlText' style='width:95%;text-align:right' /></td> 
                        </tr> 
                        <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intVinesOpening"].": </label></td>
                           <td><input type='text'  name='' id='intVinesOpening' onChange  class='controlText' style='width:95%;text-align:right' /></td> 
                        </tr>
                         <tr>
                           <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblHectare"].": </label></td>
                           <td><input type='text' name='' id='dblHectare' onChange  class='controlLabel' style='width:99%;text-align:right;border-top:1px solid #000000 ;' /></td> 
                        </tr>
                     </table>
                  </div>
               </div>
               <div style='clear:both;'></div>
               <div style='width:100%;'>
                  <table width='100%' cellpadding=0 cellspacing=0 border=0>
                     <tr>
                        <td><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refTrellisID"].": </label>
                          <select name='' id='refTrellisID' onChange  style=' width:53%;margin-left:188px' class='controlText' >
                              <option value='0'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["optSelect"]." </option>$ddlTrellis</select>
                           <a  id='aTrellis' href target='_blank' style ='margin-left:40px' hidden>-".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]."-</a></td>
                          </select>
                        </td>
                     </tr>
                     <tr>
                        <td>
                           <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGPS"].": </label>
                           <input type='text' name='' id='strGPS' class='controlText' onChange style='width:52%;margin-left:201px' maxlength='100'/><a id='mapLink' href='http://maps.google.com' target='_blank' style='padding-left:13px' hidden>-".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkViewMap"]."-</a>
                        </td> 
                     </tr>
                     <tr><td><a href='".$SystemSettings[GISProjectURL]."' target='_blank' style='margin-left:231px'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGISProject"]."</a></td></tr>
                     
                     <tr>
                        <td width='100%'>
                          <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strDescription"]."</label> 
                           $BR <textarea name='' id='txtDescription' class='controlText' style='width:98%;' ></textarea>
                        </td> 
                     </tr>
               </table>
            </div>
            <div id='ErrorContent_intYear' class='Error_Text'></div>
            <div id='ErrorContent_BlockName' class='Error_Text'></div>
            <div id='ErrorContent_Variety' class='Error_Text'></div>
            <div id='ErrorContent_Rootstock' class='Error_Text'></div>
            <div id='ErrorContent_Irrigation' class='Error_Text'></div>
            <div id='ErrorContent_Trellis' class='Error_Text'></div>
            <div id='ErrorContent_Specifications' class='Error_Text'></div>
            <div id='ErrorContent_Specifications_Width' class='Error_Text'></div>
         </div>
         <div style='border-bottom:1px groove #333;'></div>$BR
         </div>";

      $Content = "<div>
                     <table width='100%' style='margin-top:12px;'>
                        <tr>
                           <td><label for='OptionA1'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["TitleBlocks"].":</label>$imgRequired</td>
                           <td align='right' colspan='2'>
                           $btnAddBlock
                           </td> 
                        </tr>
                     </table>
                  </div>
                  <div style='border-bottom:1px groove #333;'></div>$BR
                  $BlockContent
                  $COPYCONTENT
                  <input type='hidden' value='1' name='saveData' />";

      ## RETURN
      return $Content . js("

        
       // /*$('form').submit(function( event ) 
       //   {
       //      var blockData = $(this).serializeArray();
       //      console.log(blockData);

       //      $.each( blockData, function( key, value ) 
       //      {
       //         alert(blockData[key].name+'-'+blockData[key].value);
       //      });

       //     event.preventDefault();
       //   });*/
         
         function jsValidation()
         {
            var arrBlock = $('div[name=\"arrBlock\"]');
            var validToSubmit = true;

            $.each(arrBlock, function()
            {

               var blockID = this.id;
               var blockIsValid = true;
               var currentYear = new Date().getFullYear();

               if(($('#intYear_'+blockID).val() == 0) || ($('#intYear_'+blockID).val() < 1920) || ($('#intYear_'+blockID).val() > currentYear))
               {
                  $('#ErrorContent_intYear_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Year"]."\")
                  $('#ErrorContent_intYear_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_intYear_'+blockID).slideUp('fast');
               }
               
               if($('#strBlock_'+blockID).val() == '')
               {
                  $('#ErrorContent_BlockName_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_BlockName"]."\")
                  $('#ErrorContent_BlockName_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_BlockName_'+blockID).slideUp('fast');
               }

               if($('#refCultivarID_'+blockID).val() == '0')
               {
                  $('#ErrorContent_Variety_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Variety"]."\")
                  $('#ErrorContent_Variety_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_Variety_'+blockID).slideUp('fast');
               }

               if($('#refCultivarRootstockID_'+blockID).val() == '0' && $('#blnGraft_'+blockID).is(':checked'))
               {
                  $('#ErrorContent_Rootstock_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Rootstock"]."\")
                  $('#ErrorContent_Rootstock_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_Rootstock_'+blockID).slideUp('fast');
               }

               if($('#refIrrigationID_'+blockID).val() == '0')
               {
                  $('#ErrorContent_Irrigation_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Irrigation"]."\")
                  $('#ErrorContent_Irrigation_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_Irrigation_'+blockID).slideUp('fast');
               }


               if($('#refTrellisID_'+blockID).val() == '0')
               {
                  $('#ErrorContent_Trellis_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Trellis"]."\")
                  $('#ErrorContent_Trellis_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_Trellis_'+blockID).slideUp('fast');
               }

               if(($('#dblHectare_'+blockID).val() == '0') || ($('#dblRowSpacingWide_'+blockID).val() == '0') || ($('#dblVineSpacing_'+blockID).val() == '0') || ($('#intVinesOpening_'+blockID).val() == '0'))
               {
                  $('#ErrorContent_Specifications_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Specifications"]."\")
                  $('#ErrorContent_Specifications_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_Specifications_'+blockID).slideUp('fast');
               }

               if(parseFloat($('#dblRowSpacingWide_'+blockID).val()) < parseFloat($('#dblVineSpacing_'+blockID).val()))
               {
                  $('#ErrorContent_Specifications_Width_'+blockID).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Specifications_Width"]."\")
                  $('#ErrorContent_Specifications_Width_'+blockID).slideDown('fast');
                  blockIsValid = false;
               }
               else
               {
                  $('#ErrorContent_Specifications_Width_'+blockID).slideUp('fast');
               }


               if(blockIsValid == false)
               {
                  //alert('Check Farm Block/s there are some values missing.');
                  $('#DD_'+blockID).slideDown(300)
                  validToSubmit = false;
               }

            });
            
            if(validToSubmit == false)
               alert(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["validationMessage"]."\");

            return validToSubmit;

         }

         function jsRemoveBlock(blockRemove,blockID,tmpBlockID)
         { 
            if(confirm(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["deleteBlockMessage"]."\"))
            {
               $('#arrDelete_'+blockID).val('1');
               $(blockRemove).parent().parent().remove();
            }
         }

         function jsChangeName(idx)
         {  
            BlockName = $('#jsRemoveBlock'+idx).val();  
            $('#BlockName_'+idx).html(BlockName)

         }

         function jsAccordian(block)
         {
            BlockID = block.id; 
            
            Question_Status = $('#status_'+BlockID);
            Question_DD = $('#DD_'+BlockID);
            Question_Image  = $('#DD_Img'+BlockID);

            $('.dd').slideUp(300);
            $('.Block_Img').attr('src','images/arrow_blue.png');
            $('.h3x').css('color', '#000000');

            if(!$(Question_DD).is(':visible'))
            { 
               Question_Status.val('ON');
               Question_DD.slideDown(300)
               Question_Image.attr('src','images/arrow_gray.png');
               $('#'+BlockID).css('color', '#333333');
            } 
            else
            { 
               Question_Status.val('OFF');
               Question_DD.slideUp(300)
               Question_Image.attr('src','images/arrow_blue.png');
               $('#'+BlockID).css('color', '#000000');
            } 
         }

         var uniqueID = -1;
         function jsAddBlock()
         { 
            var copy = $('#CopyBlock').clone(true).insertAfter('#CopyBlock');
            var trID = 'CopyBlock_'+ uniqueID;
            copy.attr('id', trID);

            $('#CopyBlock_'+uniqueID).find('.BlockHeader').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', uniqueID); 
            });

            $('#CopyBlock_'+uniqueID).find('#status').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', Id+'_'+uniqueID); 
            });

            $('#CopyBlock_'+uniqueID).find('#arrDelete').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('name', Id+'['+uniqueID+']');
            });

            $('#CopyBlock_'+uniqueID).find('#arrID').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('name', Id+'['+uniqueID+']');
            });

            $('#CopyBlock_'+uniqueID).find('#DD_Img').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', Id+uniqueID); 
            });

            $('#CopyBlock_'+uniqueID).find('#remove').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', Id+uniqueID); 
            });

            $('#CopyBlock_'+uniqueID).find('.CopyCounter').each(function(){ 
               $(this).html('+ :'); 
            });

            $('#CopyBlock_'+uniqueID).find('#BlockName').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', Id+'_'+uniqueID); 

            });

            $('#CopyBlock_'+uniqueID).find('#DD').each(function(){
               var Id = $(this).attr('id'); 
               $(this).attr('id', Id+'_'+uniqueID); 
            });

            $('#CopyBlock_'+uniqueID).find('#Block_ID').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'Block_ID['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $('#'+Id+'_'+uniqueID).val(uniqueID)
               $(this).addClass('strBlock_ID');
            });

            $('#CopyBlock_'+uniqueID).find('#intYear').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'intYear['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'jsIsValidYear('+uniqueID+')');
            });

            $('#CopyBlock_'+uniqueID).find('#ErrorContent_intYear').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#strBlock').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'strBlock['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'jsIsValidBlockName('+uniqueID+')');
            });

            $('#CopyBlock_'+uniqueID).find('#ErrorContent_BlockName').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#refCultivarID').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'refCultivarID['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'jsIsValidVariety('+uniqueID+')');
               $(this).val('');
            });
            
             $('#CopyBlock_'+uniqueID).find('#ErrorContent_Variety').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#refCultivarRootstockID').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'refCultivarRootstockID['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'jsIsValidRootstock('+uniqueID+')');
               $(this).val('');
            });

             $('#CopyBlock_'+uniqueID).find('#ErrorContent_Rootstock').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#refIrrigationID').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'refIrrigationID['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'jsIsValidIrrigation('+uniqueID+')');
               $(this).val('');
            });

             $('#CopyBlock_'+uniqueID).find('#ErrorContent_Irrigation').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#refTrellisID').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'refTrellisID['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'jsIsValidTrellis('+uniqueID+');jsGetTrellisImage(this,'+uniqueID+')');
               $(this).val('');

            });
            
            $('#CopyBlock_'+uniqueID).find('#aTrellis').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#strGPS').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'jsShowGoogleMap('+uniqueID+')');

            });

            $('#CopyBlock_'+uniqueID).find('#mapLink').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);

            });

              $('#CopyBlock_'+uniqueID).find('#ErrorContent_Trellis').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });
               
               
            $('#CopyBlock_'+uniqueID).find('#dblHectare').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'dblHectare['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'removeAlpha(this);jsCalculateHectare('+uniqueID+')');
               $(this).val('0');
            });   


            $('#CopyBlock_'+uniqueID).find('#dblRowSpacingNarrow').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'dblRowSpacingNarrow['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).val('0');
            });

            $('#CopyBlock_'+uniqueID).find('#dblRowSpacingWide').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'dblRowSpacingWide['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'removeAlpha(this);jsCalculateHectare('+uniqueID+');jsIsValidWidth('+uniqueID+')');
               $(this).val('0');
            });
            

            $('#CopyBlock_'+uniqueID).find('#dblVineSpacing').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'dblVineSpacing['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'removeAlpha(this);jsCalculateHectare('+uniqueID+');jsIsValidWidth('+uniqueID+')');
               $(this).val('0');
            });
            

            $('#CopyBlock_'+uniqueID).find('#txtDescription').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'txtDescription['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#intVinesOpening').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'intVinesOpening['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onChange', 'removeAlpha(this);jsCalculateHectare('+uniqueID+')');
               $(this).val('0');
            });

            $('#CopyBlock_'+uniqueID).find('#blnGraft').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('name', 'blnGraft['+uniqueID+']');
               $(this).attr('id', Id+'_'+uniqueID);
               $(this).attr('onClick', 'jsToggleRootstock('+uniqueID+')');
               $(this).val('0');
            });

            $('#CopyBlock_'+uniqueID).find('#ErrorContent_Specifications').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).find('#ErrorContent_Specifications_Width').each(function(){
               var Id = $(this).attr('id');
               $(this).attr('id', Id+'_'+uniqueID);
            });

            $('#CopyBlock_'+uniqueID).css('display','');

            uniqueID--;
         }

         //Load Image for Trellis
         function jsGetTrellisImage(ddlTrellis, x)
         {
            var linkTrellis = $('#aTrellis_'+ x);
            var fileName = $('#refTrellisID_'+ x).find(':selected').attr('filename');
            var imageUrl = 'images/trellising/' + fileName;

            linkTrellis.hide('fast');
            linkTrellis.attr('href', '');

            if(fileName != '')
            {
               linkTrellis.show('fast');
               linkTrellis.attr('href', imageUrl);
            }
         }

         function jsIsValidYear(x)
         {
            var currentYear = new Date().getFullYear();

            if(($('#intYear_'+x).val() == 0) || ($('#intYear_'+x).val() < 1920) || ($('#intYear_'+x).val() > currentYear))
            {
               $('#ErrorContent_intYear_'+x).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Year"]."\")
               $('#ErrorContent_intYear_'+x).slideDown('fast');
            }
            else
            {
                $('#ErrorContent_intYear_'+x).slideUp('fast');
            }
         }

         function jsIsValidBlockName(x)
         {

            if($('#strBlock_'+x).val() == '')
            {
               $('#ErrorContent_BlockName_'+x).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_BlockName"]."\")
               $('#ErrorContent_BlockName_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_BlockName_'+x).slideUp('fast');
            }
         }

         function jsIsValidVariety(x)
         {

            if($('#refCultivarID_'+x).val() == '0')
            {
               $('#ErrorContent_Variety_'+x).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Variety"]."\")
               $('#ErrorContent_Variety_'+x).slideDown('fast');
            }
             else
            {
               $('#ErrorContent_Variety_'+x).slideUp('fast');
            }
         }


         function jsIsValidRootstock(x)
         {

            if($('#refCultivarRootstockID_'+x).val() == '0')
            {
               $('#ErrorContent_Rootstock_'+x).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Rootstock"]."\")
               $('#ErrorContent_Rootstock_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_Rootstock_'+x).slideUp('fast');
            }
         }

         function jsIsValidWidth(x)
         {
            if(parseFloat($('#dblRowSpacingWide_'+x).val()) < parseFloat($('#dblVineSpacing_'+x).val()))
            {
               $('#ErrorContent_Specifications_Width_'+x).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Specifications_Width"]."\")
               $('#ErrorContent_Specifications_Width_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_Specifications_Width_'+x).slideUp('fast');
            }
         }

         function jsIsValidIrrigation(x)
         {
            if($('#refIrrigationID_'+x).val() == '0')
            {
               $('#ErrorContent_Irrigation_'+x).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Irrigation"]."\")
               $('#ErrorContent_Irrigation_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_Irrigation_'+x).slideUp('fast');
            }
         
         }

         function jsIsValidTrellis(x)
         {
            if($('#refTrellisID_'+x).val() == '0')
            {
               $('#ErrorContent_Trellis_'+x).html(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_Trellis"]."\")
               $('#ErrorContent_Trellis_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_Trellis_'+x).slideUp('fast');
            }
         }

         function jsIsValidRowSpacingWide(x)
         {
            if($('#dblRowSpacingWide_'+x).val() == '0')
            {
               $('#ErrorContent_Specifications_'+x).append(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_RowSpacingWide"]."\")
               $('#ErrorContent_Specifications_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_RowSpacingWide_'+x).slideUp('fast');
            }
         }

         function jsIsValidVineSpacing(x)
         {
            if($('#dblVineSpacing_'+x).val() == '0')
            {
               $('#ErrorContent_Specifications_'+x).append(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_VineSpacing"]."\")
               $('#ErrorContent_Specifications_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_VineSpacing_'+x).slideUp('fast');
            }
         }

         function jsIsValidVinesOpening(x)
         {
            if($('#intVinesOpening_'+x).val() == '0')
            {
               $('#ErrorContent_Specifications_'+x).append(\"".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["valid_VinesOpening"]."\")
               $('#ErrorContent_Specifications_'+x).slideDown('fast');
            }
            else
            {
               $('#ErrorContent_VinesOpening_'+x).slideUp('fast');
            }
         }

         function jsIsSpecifications(x)
         {
            
            
               jsCalculateHectare(x);
             
         }

         function jsCalculateHectare(x)
         {
            
            var RowSpacingWide = parseFloat($('#dblRowSpacingWide_'+x).val());
            var RowSpacingNarrow = parseFloat($('#dblRowSpacingNarrow_'+x).val());
            var VineSpacing = parseFloat($('#dblVineSpacing_'+x).val());
            var NumberOfVines = parseFloat($('#intVinesOpening_'+x).val());

            var Hectare = parseFloat(((RowSpacingWide + RowSpacingNarrow)/2 * VineSpacing * NumberOfVines)).toFixed(4);

            $('#dblHectare_'+x).val(Hectare);
         
         }

         function jsShowGoogleMap(x)
         {
            var location = $('#strGPS_'+x).val();

            if(location != '')
            {
               $('#mapLink_'+x).attr('href','https://www.google.co.za/maps/place/'+location);
               $('#mapLink_'+x).show('fast');
            }
            else
            {
               $('#mapLink_'+x).hide();
            }
            
         }

         function jsCheckImageShow(x)
         {
            if($('#refTrellisID_'+x).val() != 0)
               $('#aTrellis_'+x).show('fast');

            if($('#strGPS_'+x).val() != '')
               $('#mapLink_'+x).show('fast');
         }

         function jsToggleRootstock(x)
         {
            if($('#blnGraft_'+x).is(':checked'))
            {
               $('#refCultivarRootstockID_'+x).removeAttr('disabled');
            }
            else
            {
               $('#refCultivarRootstockID_'+x).attr('disabled','disabled');
            }
         }

         ");
   }

   ## GET THE REVIEW CONTENT ##############################################################################################################################################################
   ########################################################################################################################################################################################
   ########################################################################################################################################################################################

   public function getReviewContent($FarmID)
   {   
      global $xdb, $arrSys, $TR, $SP, $HR,$BR, $DATABASE_SETTINGS, $SystemSettings,$_TRANSLATION; 

      ## INI
      $iconWrong = "<img src='images/wrong_icon.png' />";
      $iconCorrect = "<img src='images/icon-correct.png' />";
      
      ## LOAD
      $DoneFB = $iconWrong; 
      $BlockCount = 0;
      //$Language = $_SESSION[USER]->LANGUAGE; nooooooo!
      $FarmBlockContent = "";

      ## GET FARM BLOCKS DETAILS
      $rstBlock = $xdb->doQuery(" SELECT   *
            , vieCultivar_". $_SESSION[USER]->LANGUAGE .".strCultivar AS 'strCultivar'
            , vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE .".strCultivar AS strCultivarRootstock
            , vieIrrigation_". $_SESSION[USER]->LANGUAGE .".strIrrigation AS 'strIrrigation'
            , vieTrellis_". $_SESSION[USER]->LANGUAGE .".strTrellis AS 'strTrellis'
            , vieTrellis_". $_SESSION[USER]->LANGUAGE .".strDescription as strTrellisDescription
         FROM tmpBlock 
            LEFT JOIN vieCultivar_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refCultivarID = vieCultivar_". $_SESSION[USER]->LANGUAGE .".CultivarID
            LEFT JOIN vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refCultivarRootstockID = vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE .".CultivarID
            LEFT JOIN vieIrrigation_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refIrrigationID = vieIrrigation_". $_SESSION[USER]->LANGUAGE .".IrrigationID
            LEFT JOIN vieTrellis_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refTrellisID = vieTrellis_". $_SESSION[USER]->LANGUAGE .".TrellisID
         WHERE refFarmID = '$FarmID' AND tmpBlock.strStatus = 'New'
         ORDER BY strBlock");

      while($rowBlock = $xdb->fetch_object($rstBlock))
      {
         //ini
         $BlockCount++;

         if($rowBlock->strCultivarRootstock == "")
         {
            $rowBlock->strCultivarRootstock = $_TRANSLATION[$_SESSION[USER]->LANGUAGE]["notGrafted"];
         }

         $ViewTrellis = ""; 
         if($rowBlock->strFilename != NULL)
         {
            $ViewTrellis = "<a target='blank' href='images/trellising/$rowBlock->strFilename' style='padding-left:30px'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
         }

         $ViewGPS = ""; 
         if($rowBlock->strGPS != "")
         {
            $ViewGPS = "<a href='https://www.google.co.za/maps/place/$rowBlock->strGPS' target='_blank' style='padding-left:40px'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
         }         
         //Shorten Long GPS strings
         if(strlen($rowBlock->strGPS) > 25)
         {
            $shortGPS = substr($rowBlock->strGPS, 0, 25);
            $rowBlock->strGPS = $shortGPS."...";
         }

         //go
         $FarmBlockContent .= "
            <div class='reviewBlock'>
               <div class='reviewBlockHeading'>$BlockCount) ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strBlock"].": $rowBlock->strBlock</div>
               <table class='SectionList' width=100% cellpadding=1 cellspacing=1 border=0>
                  <tr>
                     <td colspan='1' width=120px nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intYear"].":</label></td>
                     <td colspan='2' ><b>$rowBlock->intYear</td>
                  </tr>  
                  <tr>
                     <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarID"].":</label></td>
                     <td colspan='2'><b>$rowBlock->strCultivar</b></td>
                  </tr> 
                  <tr>
                     <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarRootstockID"].":</label></td>
                     <td colspan='2'><b>$rowBlock->strCultivarRootstock</b></td>
                  </tr> 
                  <tr>
                     <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refIrrigationID"].":</label></td>
                     <td colspan='2'><b>$rowBlock->strIrrigation</b></td>
                  </tr> 
                  <tr>
                     <td colspan='1' nowrap>
                        <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refTrellisID"].": $ViewTrellis</label>
                     </td>
                     <td colspan='2' nowrap><b>$rowBlock->strDescription</b></td>
                  </tr> 
                  <tr>
                     <td colspan='1' nowrap>
                        <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGPS"].": $ViewGPS</label>
                     </td>
                     <td colspan='2'><b>$rowBlock->strGPS</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblHectare"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblHectare</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingWide"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblRowSpacingWide</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2'  nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingNarrow"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblRowSpacingNarrow</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblVineSpacing"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblVineSpacing</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intVinesOpening"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->intVinesOpening</b></td>
                  </tr>
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblHectare"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblHectare</b></td>
                  </tr>    
               </table>
            </div>";
      }
      
      ## CHECK NUMBER OF BLOCKS MORE THAN ONE
      if($BlockCount >= 1)
      {
         $DoneFB = $iconCorrect;
      }  

      ## CREATE HTML
      $strContent = "<div class='reviewWrapper'>
                        
                        <div class='reviewSection'>
                           <h6 class='SectionHeader'>
                              <a href='registration.member.php?Step=1'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["FarmBHeading"]."</a>
                              $DoneFB
                           </h6> 
                           $FarmBlockContent
                           <div style='clear:both;'></div>
                        </div>  
                     </div>";
      return $strContent;
   }


   public function GetCompletedContent($FarmID)
   {
      global $xdb, $BR, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings;


      ## GET CURRENT ARGUMENTS ARRAY
      $row = $xdb->getRowSQL("SELECT * FROM tblMember WHERE MemberID = '". $_SESSION[S3REGISTRATION]->MemberID. "'");

      if($row->RegistrationArgs != "")
      { 
         $decode64 = base64_decode($row->RegistrationArgs);
         $Args = unserialize($decode64);
      }
      
      $Content = "Done and Dusted. To go back to your SAWIS profile please, <a href='my.profile.php'><input type='button' class='controlButton' style='width:70px; margin-left:10px;' value='Click Here' /></a>";
       
      return $Content;
   }


   public static function Save($FarmID, $step)
   {
      //print_rr($_POST);die();
      global $xdb, $arrSys, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings, $DT;

      ## INI
 
      ## PROSESS NAME
      $strProcessName = "S1 Registration"; 

      ## SWITCH STATEMENT FOR STEPS
      switch ($step) 
      {  
         ## LANDING PAGE
         case "0":    
            $_SESSION[S1REGISTRATION]->NumberBlocks = $_POST[intNumbBlocks]; 
            break;

         ## BLOCK SETUP
         case "1":    
            
            unset($_SESSION[S1REGISTRATION]->NumberBlocks);

            //$xdb->doQuery("DELETE FROM tmpBlock WHERE refFarmID = $FarmID");
            //print_rr($_POST[arrDelete]);
             
            
            foreach($_POST[arrID] AS $key => $value)
            {
               //echo "KEY->$key<br>";
            //ini
               if(!empty($_POST[arrID][$key]))
               {
                  $ID = $_POST[arrID][$key];
                  $dbBlock = new NemoDatabase("tmpBlock", $ID, null, 0);
               }
               else
               {
                  unset($ID);
                  $dbBlock = new NemoDatabase("tmpBlock", null, null, 0);
               ## CREAT BLOCK ID :: FIRST 6 NUMBERS FROM FARMID AND 6 RANDOM CHARS
                  $BlockID = str_pad(substr($FarmID, 0,5), 6, "0", STR_PAD_LEFT) . Obfuscate();
                  $dbBlock->Fields["BlockID"] = $BlockID; //BR: only assign BlockID for new blocks!
               }

               if($_POST[arrDelete][$key] == 0)
               {
                  $dbBlock->Fields["refFarmID"] = $FarmID; 
                  $dbBlock->Fields["intYear"] = $_POST[intYear][$key];  
                  $dbBlock->Fields["strBlock"] = $_POST[strBlock][$key]; 
                  $dbBlock->Fields["strDescription"] = $_POST[txtDescription][$key]; 
                  $dbBlock->Fields["refCultivarID"] = $_POST[refCultivarID][$key]; 

                  #BusinessRule: Rootstock is = to Cultivar, unless it is grafted onto a rootstock-only cultivar
                  if($_POST[refCultivarRootstockID][$key] != 0) //if this is not equal to select
                  {
                     $dbBlock->Fields["refCultivarRootstockID"] = $_POST[refCultivarRootstockID][$key]; 
                  }else{
                     $dbBlock->Fields["refCultivarRootstockID"] = $_POST[refCultivarID][$key];
                  }
                  $dbBlock->Fields["refIrrigationID"] = $_POST[refIrrigationID][$key]; 
                  $dbBlock->Fields["refTrellisID"] = $_POST[refTrellisID][$key];
                  $dbBlock->Fields["strGPS"] = $_POST[strGPS][$key];  
                  $dbBlock->Fields["dblHectare"] = $_POST[dblHectare][$key]; 
                  $dbBlock->Fields["dblRowSpacingWide"] = $_POST[dblRowSpacingWide][$key]; 
                  $dbBlock->Fields["dblRowSpacingNarrow"] = $_POST[dblRowSpacingNarrow][$key];
                  $dbBlock->Fields["dblVineSpacing"] = $_POST[dblVineSpacing][$key];
                  $dbBlock->Fields["intVinesOpening"] = $_POST[intVinesOpening][$key];
                  $dbBlock->Fields["intVinesClosing"] = $_POST[intVinesOpening][$key];
                  $dbBlock->Fields["strStatus"] = "New";
                  $dbBlock->Fields["strLastUser"] = $strProcessName;
               
                  $result = $dbBlock->Save(0,0);
                  $ID = $result->ID; 

               }
               else
               {
                  //echo 'Delete block ID '.$_POST[arrID][$key].'<br>';
                  $xdb->doQuery("DELETE FROM tmpBlock WHERE ID = ".$value,1);
               }
                  
            } 
            break;   
      } 
   }


   ## Change to Production block and add Movement Block Record
   public static function SubmitBlocks($FarmID)
   {
      global $xdb, $arrSys, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings, $DT;

      // $rst = $xdb->doQuery("SELECT * FROM tmpBlock WHERE refFarmID = $FarmID AND strStatus = 'New'");
      // while($row = $xdb->fetch_object($rst))
      // {
      //    $xdb->doQuery("UPDATE tmpBlock SET strStatus = 'Production' WHERE ID = $row->ID");
      //    //recordBlockMovement($row->BlockID, $_SESSION[USER]->ID, $row->intYear, date("Y-m-d"), "New", $row->intVinesOpening, "", "", $row->dblHectare); //20151112 - n/a - happens on S2.Approve() - pj
      // }//die("20151019 - CHECKED - pj");
      $xdb->doQuery("UPDATE tmpBlock SET strStatus = 'Production' WHERE refFarmID = $FarmID AND strStatus = 'New'");
      
      $xdb->doQuery("UPDATE tblFarm SET strVineStatus = 'Active' WHERE FarmID = $FarmID");
   }

   public function getSubdivisionContent($FarmID)
   {
      global $xdb, $arrSys, $TR, $SP, $HR,$BR, $DATABASE_SETTINGS, $SystemSettings,$_TRANSLATION; 
      print_rr("asd");
      ## INI
      $iconWrong = "<img src='images/wrong_icon.png' />";
      $iconCorrect = "<img src='images/icon-correct.png' />";
   
    
      ## LOAD
      $DoneFB = $iconWrong; 
      $BlockCount = 0;
      //$Language = $_SESSION[USER]->LANGUAGE; nooooooo!
      $FarmBlockContent = "";

      ## GET FARM BLOCKS DETAILS
      $rstBlock = $xdb->doQuery(" SELECT   *
            , vieCultivar_". $_SESSION[USER]->LANGUAGE .".strCultivar AS 'strCultivar'
            , vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE .".strCultivar AS strCultivarRootstock
            , vieIrrigation_". $_SESSION[USER]->LANGUAGE .".strIrrigation AS 'strIrrigation'
            , vieTrellis_". $_SESSION[USER]->LANGUAGE .".strTrellis AS 'strTrellis'
            , vieTrellis_". $_SESSION[USER]->LANGUAGE .".strDescription as strTrellisDescription
         FROM tblBlock
            LEFT JOIN vieCultivar_". $_SESSION[USER]->LANGUAGE ." ON tblBlock.refCultivarID = vieCultivar_". $_SESSION[USER]->LANGUAGE .".CultivarID
            LEFT JOIN vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE ." ON tblBlock.refCultivarRootstockID = vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE .".CultivarID
            LEFT JOIN vieIrrigation_". $_SESSION[USER]->LANGUAGE ." ON tblBlock.refIrrigationID = vieIrrigation_". $_SESSION[USER]->LANGUAGE .".IrrigationID
            LEFT JOIN vieTrellis_". $_SESSION[USER]->LANGUAGE ." ON tblBlock.refTrellisID = vieTrellis_". $_SESSION[USER]->LANGUAGE .".TrellisID
         WHERE refFarmID = '$FarmID'
         ORDER BY strBlock");

      while($rowBlock = $xdb->fetch_object($rstBlock))
      {
         
         //print_rr($rowBlock);

         $BlockCount++;

          $View = ""; 
         if($rowBlock->strFilename != NULL)
         {
            $View = "<a target='blank' href='images/trellising/$rowBlock->strFilename' style='padding-left:30px'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
         }

         $ViewGPS = ""; 
         if($rowBlock->strGPS != "")
         {
            $ViewGPS = "<a href='https://www.google.co.za/maps/place/$rowBlock->strGPS' target='_blank' style='padding-left:40px'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
         }
         
         //Shorten Long GPS strings
         if(strlen($rowBlock->strGPS) > 25)
         {
            $shortGPS = substr($rowBlock->strGPS, 0, 25);
            $rowBlock->strGPS = $shortGPS."...";
         }

         $FarmBlockContent .= "
            <div class='reviewBlock'>
               <input type='hidden' name='arrID[$BlockCount]' value='$rowBlock->BlockID' />
               <input type='hidden' id='arrKeepBlock_$BlockCount' name='arrKeepBlock[$BlockCount]' value='0'>
               <div class='reviewBlockHeading' style='height:25px'>$BlockCount) ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strBlock"].": $rowBlock->strBlock <a><img id='imgSelect_$BlockCount' onClick='jsSelectFarm($BlockCount)' style='float:right;'src='./images/unchecked checkbox.png'></a></div>
               <table class='SectionList' width=100% cellpadding=1 cellspacing=1 border=0>
                  <tr>
                     <td colspan='1' width=120px nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intYear"].":</label></td>
                     <td colspan='2' ><b>$rowBlock->intYear</td>
                  </tr>  
                  <tr>
                     <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarID"].":</label></td>
                     <td colspan='2'><b>$rowBlock->strCultivar</b></td>
                  </tr> 
                  <tr>
                     <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarRootstockID"].":</label></td>
                     <td colspan='2'><b>$rowBlock->strCultivarRootstock</b></td>
                  </tr> 
                  <tr>
                     <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refIrrigationID"].":</label></td>
                     <td colspan='2'><b>$rowBlock->strIrrigation</b></td>
                  </tr> 
                  <tr>
                     <td colspan='1' nowrap>
                        <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refTrellisID"].":$View</label>
                     </td>
                     <td colspan='2'><b>$rowBlock->strDescription</b></td>
                  </tr>
                   <tr>
                     <td colspan='1' nowrap>
                        <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGPS"].":$ViewGPS</label>
                     </td>
                     <td colspan='2'><b>$rowBlock->strGPS</b></td>
                  </tr>  
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingWide"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblRowSpacingWide</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingNarrow"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblRowSpacingNarrow</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblVineSpacing"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblVineSpacing</b></td>
                  </tr> 
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intVinesOpening"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->intVinesOpening</b></td>
                  </tr>
                  <tr>
                     <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblHectare"].":</label></td>
                     <td colspan='1' align=right><b>$rowBlock->dblHectare</b></td>
                  </tr>    
               </table>
            </div>";
      }
      
      ## CREATE HTML
      $strContent = "<div class='reviewWrapper'>
                        
                        <div class='reviewSection'>
                           <h6 class='SectionHeader' style='color:#51732c'>
                              ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["subDivInstructions"]."
                           </h6>
                           $FarmBlockContent
                           <div style='clear:both;'></div>
                        </div>  
                     </div>";


      return $strContent. js("

      function jsSelectFarm(blockNumber)
      {
         $('#arrKeepBlock_'+blockNumber).val('1');
         $('#imgSelect_'+blockNumber).attr('src', './images/checked checkbox.png');
         $('#imgSelect_'+blockNumber).attr('onClick', 'jsUnSelectFarm('+blockNumber+')');
         
      }

       function jsUnSelectFarm(blockNumber)
      {
         $('#arrKeepBlock_'+blockNumber).val('0');
         $('#imgSelect_'+blockNumber).attr('src', './images/unchecked checkbox.png');
         $('#imgSelect_'+blockNumber).attr('onClick', 'jsSelectFarm('+blockNumber+')');   
         
      }

      ");
   }

   public function reviewSubdivisionContent($FarmID,$arrBlockStatus,$arrBlockIDs)
   {
      global $xdb, $arrSys, $TR, $SP, $HR,$BR, $DATABASE_SETTINGS, $SystemSettings,$_TRANSLATION; 

      ## INI
      $TransferHeading = "";
      $NoTransferHeading = "";

    
      ## LOAD
      $DoneFB = $iconWrong; 
      $BlockCount = 0;
      //$Language = $_SESSION[USER]->LANGUAGE; nooooooo!
      $FarmBlockContent = "";
      $FarmBlockContentDiscard = "";

      ## GET FARM BLOCKS DETAILS
      $rstBlock = $xdb->doQuery(" SELECT   *
            , vieCultivar_". $_SESSION[USER]->LANGUAGE .".strCultivar AS 'strCultivar'
            , vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE .".strCultivar AS strCultivarRootstock
            , vieIrrigation_". $_SESSION[USER]->LANGUAGE .".strIrrigation AS 'strIrrigation'
            , vieTrellis_". $_SESSION[USER]->LANGUAGE .".strTrellis AS 'strTrellis'
            , vieTrellis_". $_SESSION[USER]->LANGUAGE .".strDescription as strTrellisDescription
         FROM tmpBlock 
            LEFT JOIN vieCultivar_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refCultivarID = vieCultivar_". $_SESSION[USER]->LANGUAGE .".CultivarID
            LEFT JOIN vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refCultivarRootstockID = vieCultivarRootstock_". $_SESSION[USER]->LANGUAGE .".CultivarID
            LEFT JOIN vieIrrigation_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refIrrigationID = vieIrrigation_". $_SESSION[USER]->LANGUAGE .".IrrigationID
            LEFT JOIN vieTrellis_". $_SESSION[USER]->LANGUAGE ." ON tmpBlock.refTrellisID = vieTrellis_". $_SESSION[USER]->LANGUAGE .".TrellisID
         WHERE refFarmID = '$FarmID' AND tmpBlock.strStatus = 'New'
         ORDER BY strBlock");

      while($rowBlock = $xdb->fetch_object($rstBlock))
      {
         
         $BlockCount++;
         $arrRegistrationArgs = unserialize($rowBlock->RegistrationArgs);
        // if(empty($arrBlockIDs[$BlockCount]))
            //$arrBlockStatus[$BlockCount] = $rowBlock->RegistrationArgs;


         if((($rowBlock->BlockID == $arrBlockIDs[$BlockCount]) && ($arrBlockStatus[$BlockCount] == 1)) || ($arrRegistrationArgs[transferBlock] == 1))
         {
            $View = ""; 
            if($rowBlock->strFilename != NULL)
            {
               $View = "<a target='blank' href='images/trellising/$rowBlock->strFilename' style='padding-left:30px'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
            }

            $ViewGPS = ""; 
            if($rowBlock->strGPS != "")
            {
               $ViewGPS = "<a href='https://www.google.co.za/maps/place/$rowBlock->strGPS' target='_blank' style='padding-left:40px'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
            }
            
            //Shorten Long GPS strings
            if(strlen($rowBlock->strGPS) > 25)
            {
               $shortGPS = substr($rowBlock->strGPS, 0, 25);
               $rowBlock->strGPS = $shortGPS."...";
            }

            $FarmBlockContent .= "
               <div class='reviewBlock'>
                  <div class='reviewBlockHeading' style='height:25px'>$BlockCount) ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strBlock"].": $rowBlock->strBlock </div>
                  <table class='SectionList' width=100% cellpadding=1 cellspacing=1 border=0>
                     <tr>
                        <td colspan='1' width=120px nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intYear"].":</label></td>
                        <td colspan='2' ><b>$rowBlock->intYear</td>
                     </tr>  
                     <tr>
                        <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarID"].":</label></td>
                        <td colspan='2'><b>$rowBlock->strCultivar</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarRootstockID"].":</label></td>
                        <td colspan='2'><b>$rowBlock->strCultivarRootstock</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refIrrigationID"].":</label></td>
                        <td colspan='2'><b>$rowBlock->strIrrigation</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap>
                           <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refTrellisID"].":$View</label>
                        </td>
                        <td colspan='2' nowrap><b>$rowBlock->strDescription</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap>
                           <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGPS"].":$ViewGPS</label>
                        </td>
                        <td colspan='2' nowrap><b>$rowBlock->strGPS</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingWide"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblRowSpacingWide</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingNarrow"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblRowSpacingNarrow</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblVineSpacing"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblVineSpacing</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intVinesOpening"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->intVinesOpening</b></td>
                     </tr>
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblHectare"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblHectare</b></td>
                     </tr>    
                  </table>
               </div>";
         }
         else
            if((($rowBlock->BlockID == $arrBlockIDs[$BlockCount]) && ($arrBlockStatus[$BlockCount] == 0)) || ($arrRegistrationArgs[transferBlock] == 0))
            {
               $View = ""; 
               if($rowBlock->strFilename != NULL)
               {
                  $View = "<a target='blank' href='images/trellising/$rowBlock->strFilename'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
               }

               $ViewGPS = ""; 
               if($rowBlock->strGPS != "")
               {
                  $ViewGPS = "<a href='https://www.google.co.za/maps/place/$rowBlock->strGPS' target='_blank'>- ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["linkView"]." -</a>";
               }
               
               //Shorten Long GPS strings
               if(strlen($rowBlock->strGPS) > 25)
               {
                  $shortGPS = substr($rowBlock->strGPS, 0, 25);
                  $rowBlock->strGPS = $shortGPS."...";
               }

               $FarmBlockContentDiscard .= "
                  <div class='reviewBlock'>
                  <div class='reviewBlockHeading' style='height:25px'>$BlockCount) ".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strBlock"].": $rowBlock->strBlock </div>
                  <table class='SectionList' width=100% cellpadding=1 cellspacing=1 border=0>
                     <tr>
                        <td colspan='1' width=120px nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intYear"].":</label></td>
                        <td colspan='2' ><b>$rowBlock->intYear</td>
                     </tr>  
                     <tr>
                        <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarID"].":</label></td>
                        <td colspan='2'><b>$rowBlock->strCultivar</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refCultivarRootstockID"].":</label></td>
                        <td colspan='2'><b>$rowBlock->strCultivarRootstock</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refIrrigationID"].":</label></td>
                        <td colspan='2'><b>$rowBlock->strIrrigation</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap>
                           <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["refTrellisID"].":$View</label>
                        </td>
                        <td colspan='2' nowrap><b>$rowBlock->strDescription</b></td>
                     </tr> 
                     <tr>
                        <td colspan='1' nowrap>
                           <label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["strGPS"].":$ViewGPS</label>
                        </td>
                        <td colspan='2' nowrap><b>$rowBlock->strGPS</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingWide"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblRowSpacingWide</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblRowSpacingNarrow"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblRowSpacingNarrow</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblVineSpacing"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblVineSpacing</b></td>
                     </tr> 
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["intVinesOpening"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->intVinesOpening</b></td>
                     </tr>
                     <tr>
                        <td colspan='2' nowrap><label>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["dblHectare"].":</label></td>
                        <td colspan='1' align=right><b>$rowBlock->dblHectare</b></td>
                     </tr>    
                  </table>
               </div>";
            } 
      }

      if($FarmBlockContent != "")
      {
         $TransferHeading = "<h6 class='SectionHeader' style='color:#51732c'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["reviewSubDiv1"]."<img src='images/icon-correct.png'></h6>";
      }
      
      if($FarmBlockContentDiscard != "") 
      {
         $NoTransferHeading = "<h6 class='SectionHeader' style='color:#51732c'>".$_TRANSLATION[$_SESSION[USER]->LANGUAGE]["reviewSubDiv2"]."<img src='images/wrong_icon.png'></h6>";
      }
           
      
      ## CREATE HTML
      $strContent = "<div class='reviewWrapper'>    
                        <div class='reviewSection'>        
                           $TransferHeading
                           $FarmBlockContent
                           <div style='clear:both;'></div>
                        </div>
                        <div class='reviewSection'>        
                           $NoTransferHeading
                           $FarmBlockContentDiscard
                           <div style='clear:both;'></div>
                        </div>    
                     </div>";


      return $strContent;
   }


   public static function SaveSubDivision($FarmID, $step)
   {  

      global $xdb, $arrSys, $TR, $SP, $HR,$BR, $DATABASE_SETTINGS, $SystemSettings,$_TRANSLATION; 

      
      ## CREATE NEW FARM RECORD IN TEMP FARM TABLE TO WITH THE SAME DETAILS AS THE DETAILS IN CURRENT OWNERS FARM.
      $CurrentFarmDetails = $xdb->getRowSQL("SELECT * FROM tblFarm WHERE FarmID = $FarmID");

      $RegistrationArgs = unserialize($CurrentFarmDetails->RegistrationArgs);

      $UpdatedFarmID = GetNewFarmID(1);

      $xdb->doQuery("INSERT INTO tmpFarm 
                        (  FarmID,strFarm, strRegisteredBusinessName, strRegistrationNumber, strVATRegistrationNumber, refLocationID, WOCode, WOCODECertifyBlendAs, strContact,
                           strTitle, strName, strSurname, strTel, strCell, strFax, strEmail, strWebsiteURL, strNearestTown ,txtPhysicalAddress, txtPostalAddress, dblArea, arrActNumbers,
                           arrActDescription, blnEstate, strVineStatus, strStatus, txtRegistrationNotes, txtNotes, RegistrationStatus, RegistrationType, RegistrationArgs, strLastUser)
               VALUES ( '".qs($UpdatedFarmID)."',
                        '".qs($CurrentFarmDetails->strFarm)."',
                        '".qs($CurrentFarmDetails->strRegisteredBusinessName)."',
                        '".qs($CurrentFarmDetails->strRegistrationNumber)."',
                        '".qs($CurrentFarmDetails->strVATRegistrationNumber)."',
                        '".qs($CurrentFarmDetails->refLocationID)."',
                        '".qs($CurrentFarmDetails->WOCode)."',
                        '".qs($CurrentFarmDetails->WOCODECertifyBlendAs)."',
                        '".qs($CurrentFarmDetails->strContact)."',
                        '".qs($CurrentFarmDetails->strTitle)."',
                        '".qs($CurrentFarmDetails->strName)."',
                        '".qs($CurrentFarmDetails->strSurname)."',
                        '".qs($CurrentFarmDetails->strTel)."',
                        '".qs($CurrentFarmDetails->strCell)."',
                        '".qs($CurrentFarmDetails->strFax)."',
                        '".qs($CurrentFarmDetails->strEmail)."',
                        '".qs($CurrentFarmDetails->strWebsiteURL)."',
                        '".qs($CurrentFarmDetails->strNearestTown)."',
                        '".qs($CurrentFarmDetails->txtPhysicalAddress)."',
                        '".qs($CurrentFarmDetails->txtPostalAddress)."',
                        '".qs($CurrentFarmDetails->dblArea)."',
                        '".qs($CurrentFarmDetails->arrActNumbers)."',
                        '".qs($CurrentFarmDetails->arrActDescription)."',
                        '".qs($CurrentFarmDetails->blnEstate)."',
                        '".qs($CurrentFarmDetails->strVineStatus)."',
                        '".qs($CurrentFarmDetails->strStatus)."',
                        '".qs($CurrentFarmDetails->txtRegistrationNotes)."',
                        '".qs($CurrentFarmDetails->txtNotes)."',
                        '".qs($CurrentFarmDetails->RegistrationStatus)."',
                        '".qs($CurrentFarmDetails->RegistrationType)."',
                        '".serialize($RegistrationArgs)."',
                        'System')");
      
      ## COPY SELECTED BLOCKS TO TEMP BLOCK TABLE WITH NEW FARM ID --> Blocks going to buyer
      $row = $xdb->getRowSQL("SELECT * FROM tmpFarm WHERE RegistrationArgs LIKE ('%\"". $FarmID ."\"%') AND strStatus NOT IN('Active')");
      
      foreach($_POST[arrKeepBlock] AS $Key => $value)
      { 
         if($value == 1)
         { 
            $arrSelectedBlocks[$Key] = $_POST[arrID][$Key];
         }  
      }

      CopyBlocks($FarmID, $row->FarmID, $arrSelectedBlocks, 0, 0);

      ## COPY UNSELECTED BLCOKS TO TEMP BLOCK TABLE WITH NEW FARM ID -->> Blocks going to user
      CopyBlocks($FarmID, $UpdatedFarmID, $arrSelectedBlocks,0, 1);

//print_rr($arrSelectedBlocks);die;

      //print_rr($_SESSION);die();
      global $xdb, $BR, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings;
      //print_rr($_POST);die();
      $dbBlock = new NemoDatabase("tmpBlock", $FarmID, null, 0);  

       switch ($step) 
      {  
         ## LANDING PAGE


         case "1": 

               ##

               //$Args = unserialize($dbBlock->Fields["RegistrationArgs"]);

               ## COPY SE
               foreach ($_POST[arrID] as $key => $value) 
               {
                  $arrayBlock = serialize(array('blockID'=>$value,'transferBlock'=>$_POST[arrKeepBlock][$key]));

                  //print_rr($arrayBlock);die();

                  if($_POST[arrKeepBlock][$key] == 1)
                     $xdb->doQuery("UPDATE tmpBlock SET RegistrationArgs = '$arrayBlock' WHERE refFarmID = '$FarmID' AND BlockID = '$value'",0);
                  else
                     if($_POST[arrKeepBlock][$key] == 0)
                        $xdb->doQuery("UPDATE tmpBlock SET RegistrationArgs = '$arrayBlock' WHERE refFarmID = '$FarmID' AND BlockID = '$value'",0);
               }
            break;  

         ## BLOCK SETUP
         case "2":   
           break;
      } 
   }

   ## COPY BLOCKS FROM ONE FARM TO ANOTHER 
   // function CopyBlocks($FarmIDFrom, $FarmIDTo, $arrSelectedBlocks="", $blnNotIn=0)
   // {

   //    global $xdb, $arrSys, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings; 
 
   //    $comma = "";
   //    $blockIDs = "";
   //    if($arrSelectedBlocks != "")
   //    { 
   //       foreach($arrSelectedBlocks AS $ID)
   //       {
   //          $blockIDs .= "$comma '$ID'";
   //          $comma = ",";
   //       }

   //       if($blnNotIn == 0)
   //       {
   //          $status = "IN";
   //       }
   //       else
   //       {
   //          $status = "NOT IN";
   //       }
   //       $Where = "AND BlockID $status($blockIDs)";

   //    }  
   //    $rst = $xdb->doQuery("SELECT * FROM tblBlock WHERE refFarmID = $FarmIDFrom $Where");
   //    while($row = $xdb->fetch_object($rst))
   //    {
   //       $xdb->doQuery("INSERT IGNORE INTO tmpBlock 
   //                      (refFarmID, intYear, BlockID, strBlock, strDescription, refSingleVineyardID, refCultivarID, refCultivarRootstockID, refIrrigationID, refTrellisID,
   //                      intYearPlanted, dblHectare, dblRowSpacingWide, dblRowSpacingNarrow, dblVineSpacing, dblVineDensity, strGPS, strStatus, intVinesOpening, intVinesUprooted, intVinesGrafted,
   //                      intVinesAmmended, intVinesClosing, dblHectareUprooted, dblHectareGrafted, dblHectareAmmended, intYearUprooted, intYearGrafted, intYearAmmended, txtNotes)
   //             VALUES ( $FarmIDTo,
   //                      '".qs($row->intYear)."',
   //                      '".qs($row->BlockID)."',
   //                      '".qs($row->strBlock)."',
   //                      '".qs($row->strDescription)."',
   //                      '".qs($row->refSingleVineyardID)."',
   //                      '".qs($row->refCultivarID)."',
   //                      '".qs($row->refCultivarRootstockID)."',
   //                      '".qs($row->refIrrigationID)."',
   //                      '".qs($row->refTrellisID)."',
   //                      '".qs($row->intYearPlanted)."',
   //                      '".qs($row->dblHectare)."',
   //                      '".qs($row->dblRowSpacingWide)."',
   //                      '".qs($row->dblRowSpacingNarrow)."',
   //                      '".qs($row->dblVineSpacing)."',
   //                      '".qs($row->dblVineDensity)."',
   //                      '".qs($row->strGPS)."',
   //                      'New',
   //                      '".qs($row->intVinesOpening)."',
   //                      '".qs($row->intVinesUprooted)."',
   //                      '".qs($row->intVinesGrafted)."',
   //                      '".qs($row->intVinesAmmended)."',
   //                      '".qs($row->intVinesClosing)."',
   //                      '".qs($row->dblHectareUprooted)."',
   //                      '".qs($row->dblHectareGrafted)."',
   //                      '".qs($row->dblHectareAmmended)."',
   //                      '".qs($row->intYearUprooted)."',
   //                      '".qs($row->intYearGrafted)."',
   //                      '".qs($row->intYearAmmended)."',
   //                      '".qs($row->txtNotes)."'
   //                      )");
   //    } 
   // }

   public function GetCompletedSubDivisionContent($FarmID)
   {
    /*global $xdb, $BR, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings;


      ## GET CURRENT ARGUMENTS ARRAY
      $row = $xdb->getRowSQL("SELECT * FROM tblMember WHERE MemberID = '". $_SESSION[S3REGISTRATION]->MemberID. "'");

      if($row->RegistrationArgs != "")
      { 
         $decode64 = base64_decode($row->RegistrationArgs);
         $Args = unserialize($decode64);
      }
      
      $Content = "Done and Dusted. To go back to your SAWIS profile please, <a href='my.profile.php'><input type='button' class='controlButton' style='width:70px; margin-left:10px;' value='Click Here' /></a>";
       
      return $Content;*/
   }

   public static function SubmitSubDivisionBlocks($FarmID)
   {
      /*global $xdb, $arrSys, $TR, $SP, $HR, $DATABASE_SETTINGS, $SystemSettings, $DT;

      $rst = $xdb->doQuery("SELECT * FROM tmpBlock WHERE refFarmID = $FarmID AND strStatus = 'New'");
      while($row = $xdb->fetch_object($rst))
      {
         $xdb->doQuery("UPDATE tmpBlock SET strStatus = 'Production' WHERE ID = $row->ID");
         recordBlockMovement($row->BlockID, $_SESSION[USER]->ID, $row->intYear, date("Y-m-d"), "New", $row->intVinesOpening, "", "", $row->dblHectare);
      }        */       
   }

}
?>
